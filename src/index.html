<!DOCTYPE html>
<html lang="zh-CN">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>ECH-Workers å®¢æˆ·ç«¯</title>
	<link rel="stylesheet" href="style.css">
</head>

<body>
	<div id="toast" class="message-toast"></div>

	<div class="container">
		<div class="header">
			<h1>ECH-Workers Client</h1>
			<div class="status">
				<div class="status-indicator" id="statusIndicator"></div>
				<span id="statusText">æœªè¿æ¥</span>
			</div>
		</div>

		<!-- æœåŠ¡å™¨ç®¡ç† -->
		<div class="server-management">
			<div class="section-title">ğŸŒ æœåŠ¡å™¨ç®¡ç†</div>
			<div class="server-controls">
				<select id="serverSelect" class="server-select">
					<option value="">é€‰æ‹©æœåŠ¡å™¨é…ç½®...</option>
				</select>
				<div class="btn-group">
					<button class="btn-mgr btn-blue" id="addServerBtn">æ–°å¢é…ç½®</button>
					<button class="btn-mgr btn-green" id="saveServerBtn">ä¿å­˜é…ç½®</button>
					<button class="btn-mgr btn-red" id="deleteServerBtn">åˆ é™¤é…ç½®</button>
				</div>
			</div>
		</div>

		<!-- ä»£ç†å‚æ•°é…ç½® -->
		<div class="config-grid">
			<div class="section-title" style="grid-column: span 2;">ğŸ”§ ä»£ç†å‚æ•°é…ç½®</div>

			<div class="form-group full-width">
				<label>æœåŠ¡å™¨åœ°å€</label>
				<input type="password" id="serverAddr" placeholder="example.workers.dev:443" class="password-input">
			</div>

			<div class="form-group">
				<label>èº«ä»½ä»¤ç‰Œ</label>
				<input type="password" id="token" placeholder="Token" class="password-input">
			</div>
			<div class="form-group">
				<label>ä¼˜é€‰åœ°å€</label>
				<input type="password" id="serverIp" placeholder="1.2.3.4" class="password-input">
			</div>

			<div class="form-group">
				<label>ECH åŸŸå</label>
				<input type="text" id="echDomain" value="cloudflare-ech.com">
			</div>
			<div class="form-group">
				<label>DOH åœ°å€</label>
				<input type="text" id="dnsServer" value="dns.alidns.com/dns-query">
			</div>

			<div class="form-group">
				<label>ç›‘å¬åœ°å€</label>
				<input type="text" id="listenAddr" value="127.0.0.1:30000">
			</div>
			<div class="form-group">
				<label>è·¯ç”±æ¨¡å¼</label>
				<select id="routingMode">
					<option value="global">å…¨å±€ä»£ç†</option>
					<option value="bypass_cn">ç»•è¿‡ä¸­å›½</option>
					<option value="none">ä¸æ”¹å˜ä»£ç†</option>
				</select>
			</div>
		</div>

		<!-- æ§åˆ¶æ  -->
		<div class="control-bar">
			<!-- å·¦ä¾§ï¼šå‚ç›´æ’åˆ—çš„å¼€å…³ -->
			<div class="switches-col">
				<div class="switch-item">
					<span>ç³»ç»Ÿä»£ç†</span>
					<label class="switch">
						<input type="checkbox" id="systemProxy">
						<span class="slider"></span>
					</label>
				</div>
				<div class="switch-item">
					<span>å¼€æœºå¯åŠ¨</span>
					<label class="switch">
						<input type="checkbox" id="autostart">
						<span class="slider"></span>
					</label>
				</div>
			</div>

			<!-- å³ä¾§ï¼šè¾ƒå°çš„æ§åˆ¶æŒ‰é’® -->
			<div class="actions-row">
				<button class="btn-ctrl btn-start" id="startBtn">å¯åŠ¨ä»£ç†</button>
				<button class="btn-ctrl btn-stop" id="stopBtn" disabled>åœæ­¢ä»£ç†</button>
			</div>
		</div>

		<!-- æ—¥å¿—è¾“å‡º -->
		<div class="output-section">
			<div class="output-header">
				<span>ğŸ“‹ è¿è¡Œæ—¥å¿—</span>
				<span id="clearLogs" style="color:#667eea; cursor:pointer; font-size:12px;">æ¸…ç©ºæ—¥å¿—</span>
			</div>
			<div class="output-container" id="output">
				<div>ç­‰å¾…æŒ‡ä»¤...</div>
			</div>
		</div>
	</div>

	<script>
		const { invoke } = window.__TAURI__.core;
		let isRunning = false;
		let servers = [];
		let currentServerId = null;

		const dom = {
			startBtn: document.getElementById('startBtn'),
			stopBtn: document.getElementById('stopBtn'),
			statusInd: document.getElementById('statusIndicator'),
			statusTxt: document.getElementById('statusText'),
			output: document.getElementById('output'),
			toast: document.getElementById('toast'),
			serverSelect: document.getElementById('serverSelect')
		};

		function showToast(msg, isError = false) {
			dom.toast.textContent = msg;
			dom.toast.style.display = 'block';
			dom.toast.style.background = isError ? '#f8d7da' : '#d4edda';
			dom.toast.style.color = isError ? '#721c24' : '#155724';
			setTimeout(() => dom.toast.style.display = 'none', 2000);
		}

		function updateUI(running) {
			isRunning = running;
			dom.startBtn.disabled = running;
			dom.stopBtn.disabled = !running;
			dom.statusTxt.textContent = running ? 'ä»£ç†è¿è¡Œä¸­' : 'æœªè¿æ¥';

			// ç¦ç”¨/å¯ç”¨æ‰€æœ‰é…ç½®è¾“å…¥æ¡†
			const configInputs = document.querySelectorAll('.config-grid input, .config-grid select');
			configInputs.forEach(input => {
				input.disabled = running;
			});

			// ç¦ç”¨/å¯ç”¨æœåŠ¡å™¨ç®¡ç†æŒ‰é’®
			const serverButtons = document.querySelectorAll('#addServerBtn, #saveServerBtn, #deleteServerBtn');
			serverButtons.forEach(button => {
				button.disabled = running;
			});

			// ç¦ç”¨/å¯ç”¨æœåŠ¡å™¨é€‰æ‹©ä¸‹æ‹‰æ¡†
			const serverSelect = document.getElementById('serverSelect');
			if (serverSelect) {
				serverSelect.disabled = running;
			}
		}

		function getCurrentFormData() {
			return {
				server_addr: document.getElementById('serverAddr').value,
				listen_addr: document.getElementById('listenAddr').value,
				server_ip: document.getElementById('serverIp').value,
				token: document.getElementById('token').value,
				dns_server: document.getElementById('dnsServer').value,
				ech_domain: document.getElementById('echDomain').value,
				routing_mode: document.getElementById('routingMode').value
			};
		}

		function loadServerToForm(server) {
			document.getElementById('serverAddr').value = server.server || '';
			document.getElementById('listenAddr').value = server.listen || '127.0.0.1:30000';
			document.getElementById('serverIp').value = server.ip || '';
			document.getElementById('token').value = server.token || '';
			document.getElementById('dnsServer').value = server.dns || 'dns.alidns.com/dns-query';
			document.getElementById('echDomain').value = server.ech || 'cloudflare-ech.com';
			document.getElementById('routingMode').value = server.routing_mode || 'global';
		}

		async function loadServers() {
			try {
				servers = await invoke('get_servers');
				updateServerSelect();

				// åŠ è½½å½“å‰é€‰ä¸­çš„æœåŠ¡å™¨
				const currentServer = await invoke('get_current_server');
				if (currentServer) {
					currentServerId = currentServer.id;
					dom.serverSelect.value = currentServer.id;
					loadServerToForm(currentServer);
				}
			} catch (e) {
				showToast('åŠ è½½æœåŠ¡å™¨é…ç½®å¤±è´¥: ' + e, true);
			}
		}

		function updateServerSelect() {
			dom.serverSelect.innerHTML = '<option value="">é€‰æ‹©æœåŠ¡å™¨é…ç½®...</option>';
			servers.forEach(s => {
				const opt = document.createElement('option');
				opt.value = s.id; opt.textContent = s.name;
				dom.serverSelect.appendChild(opt);
			});
		}

		dom.serverSelect.onchange = async () => {
			const id = dom.serverSelect.value;
			if (id) {
				currentServerId = id;
				try {
					await invoke('set_current_server', { serverId: id });
					const s = servers.find(x => x.id === id);
					if (s) loadServerToForm(s);
				} catch (e) {
					showToast('è®¾ç½®å½“å‰æœåŠ¡å™¨å¤±è´¥: ' + e, true);
				}
			}
		};

		document.getElementById('addServerBtn').onclick = async () => {
			const name = prompt('é…ç½®åç§°:');
			if (!name) return;

			const formData = getCurrentFormData();
			const newServer = {
				id: Date.now().toString(),
				name: name,
				server: formData.server_addr,
				listen: formData.listen_addr,
				token: formData.token,
				ip: formData.server_ip,
				dns: formData.dns_server,
				ech: formData.ech_domain,
				routing_mode: formData.routing_mode
			};

			try {
				await invoke('upsert_server', { server: newServer });
				await loadServers(); // é‡æ–°åŠ è½½
				dom.serverSelect.value = newServer.id;
				currentServerId = newServer.id;
				showToast('å·²æ–°å¢');
			} catch (e) {
				showToast('æ–°å¢æœåŠ¡å™¨å¤±è´¥: ' + e, true);
			}
		};

		document.getElementById('saveServerBtn').onclick = async () => {
			if (!currentServerId) return showToast('è¯·å…ˆé€‰æ‹©é…ç½®', true);

			const formData = getCurrentFormData();
			const updatedServer = {
				id: currentServerId,
				name: servers.find(x => x.id === currentServerId)?.name || 'æœªçŸ¥æœåŠ¡å™¨',
				server: formData.server_addr,
				listen: formData.listen_addr,
				token: formData.token,
				ip: formData.server_ip,
				dns: formData.dns_server,
				ech: formData.ech_domain,
				routing_mode: formData.routing_mode
			};

			try {
				await invoke('upsert_server', { server: updatedServer });
				await loadServers(); // é‡æ–°åŠ è½½
				showToast('å·²ä¿å­˜');
			} catch (e) {
				showToast('ä¿å­˜æœåŠ¡å™¨å¤±è´¥: ' + e, true);
			}
		};

		document.getElementById('deleteServerBtn').onclick = async () => {
			if (!currentServerId || !confirm('ç¡®è®¤åˆ é™¤ï¼Ÿ')) return;

			try {
				await invoke('delete_server', { serverId: currentServerId });
				await loadServers(); // é‡æ–°åŠ è½½
				loadServerToForm({});
				showToast('å·²åˆ é™¤');
			} catch (e) { showToast(e, true); }
		};

		document.getElementById('clearLogs').onclick = async () => {
			try {
				await invoke('clear_proxy_output');
				dom.output.innerHTML = '<div></div>';
				lastOutputLength = 0; // é‡ç½®è®¡æ•°å™¨
				showToast('æ—¥å¿—å·²æ¸…ç©º');
			} catch (e) {
				showToast('æ¸…ç©ºæ—¥å¿—å¤±è´¥: ' + e, true);
			}
		};

		document.getElementById('systemProxy').onchange = async (e) => {
			try {
				await invoke('set_system_proxy', { enabled: e.target.checked });
				showToast(e.target.checked ? 'ç³»ç»Ÿä»£ç†å·²å¯ç”¨' : 'ç³»ç»Ÿä»£ç†å·²ç¦ç”¨');
			} catch (error) {
				showToast('è®¾ç½®ç³»ç»Ÿä»£ç†å¤±è´¥: ' + error, true);
				e.target.checked = !e.target.checked; // æ¢å¤çŠ¶æ€
			}
		};

		document.getElementById('autostart').onchange = async (e) => {
			try {
				await invoke('set_autostart', { enabled: e.target.checked });
				showToast(e.target.checked ? 'å¼€æœºå¯åŠ¨å·²å¯ç”¨' : 'å¼€æœºå¯åŠ¨å·²ç¦ç”¨');
			} catch (error) {
				showToast('è®¾ç½®å¼€æœºå¯åŠ¨å¤±è´¥: ' + error, true);
				e.target.checked = !e.target.checked; // æ¢å¤çŠ¶æ€
			}
		};

		function showPasswordContent(input) {
			if (input.value) {
				input.type = 'text';
			}
		}

		function hidePasswordContent(input) {
			if (input.value) {
				input.type = 'password';
			}
		}

		// åˆå§‹åŒ–æ‰€æœ‰passwordè¾“å…¥æ¡†çš„è¾“å…¥çŠ¶æ€æ˜¾ç¤ºåŠŸèƒ½
		function initPasswordInputs() {
			const passwordInputs = document.querySelectorAll('input[type="password"]');
			passwordInputs.forEach(input => {
				input.addEventListener('focus', () => showPasswordContent(input));
				input.addEventListener('blur', () => hidePasswordContent(input));
			});
		}

		async function loadSystemSettings() {
			try {
				// è·å–å®é™…çš„ç³»ç»ŸçŠ¶æ€
				const proxyStatus = await invoke('get_system_proxy_status');
				document.getElementById('systemProxy').checked = proxyStatus;

				const autostartStatus = await invoke('get_autostart_status');
				document.getElementById('autostart').checked = autostartStatus;

				// è·å–æœ€åä¿å­˜çš„çŠ¶æ€ï¼ˆç”¨äºè°ƒè¯•å’Œæ—¥å¿—ï¼‰
				const lastState = await invoke('get_last_state');
				console.log('Last state loaded:', lastState);

				// æ£€æŸ¥å®é™…çš„ä»£ç†è¿è¡ŒçŠ¶æ€
				const actualProxyStatus = await invoke('get_proxy_status');
				console.log('Actual proxy status:', actualProxyStatus);

				// å¦‚æœå‘ç°å¤–éƒ¨è¿›ç¨‹åœ¨è¿è¡Œï¼ŒåŒæ­¥UIçŠ¶æ€
				if (actualProxyStatus.is_running) {
					console.log('Detected running proxy process, updating UI');
					updateUI(true);

					// å¦‚æœç³»ç»Ÿä»£ç†çŠ¶æ€ä¸ä¸€è‡´ï¼Œä¹ŸåŒæ­¥
					if (actualProxyStatus.system_proxy_enabled !== proxyStatus) {
						document.getElementById('systemProxy').checked = actualProxyStatus.system_proxy_enabled;
					}

					// å¦‚æœæ˜¯å¤–éƒ¨è¿›ç¨‹è¿è¡Œä½†ä¸æ˜¯æˆ‘ä»¬ç®¡ç†çš„ï¼Œæ˜¾ç¤ºæç¤º
					if (actualProxyStatus.is_external_running && !actualProxyStatus.is_managed_running) {
						console.log('External proxy process detected but not managed by this app');
						showToast('æ£€æµ‹åˆ°å¤–éƒ¨ä»£ç†è¿›ç¨‹æ­£åœ¨è¿è¡Œ', false);
					}
				}

				showToast('ç³»ç»Ÿè®¾ç½®å·²åŠ è½½');
			} catch (e) {
				showToast('åŠ è½½ç³»ç»Ÿè®¾ç½®å¤±è´¥: ' + e, true);
			}
		}

		async function pollStartupStatus(timeoutMs = 15000) {
			const startedAt = Date.now();
			const timer = setInterval(async () => {
				try {
					const status = await invoke('get_proxy_status');
					if (status.is_running) {
						updateUI(true);
						clearInterval(timer);
					} else if (Date.now() - startedAt > timeoutMs) {
						clearInterval(timer);
					}
				} catch (_) {
					clearInterval(timer);
				}
			}, 1000);
		}

		document.addEventListener('DOMContentLoaded', async () => {
			initPasswordInputs();
			await loadServers();
			await loadSystemSettings();
			await pollStartupStatus();

			setInterval(async () => {
				try {
					const status = await invoke('get_proxy_status');
					const running = status.is_running;
					if (running !== isRunning) {
						updateUI(running);
					}
					const sysEnabled = await invoke('get_system_proxy_status');
					const checkbox = document.getElementById('systemProxy');
					if (checkbox.checked !== sysEnabled) {
						checkbox.checked = sysEnabled;
					}
				} catch (_) { }
			}, 1000);
		});

		dom.startBtn.onclick = async () => {
			try {
				await invoke('start_proxy', { config: getCurrentFormData() });
				updateUI(true);
				showToast("å¯åŠ¨æˆåŠŸ");
			} catch (e) { showToast(e, true); }
		};

		dom.stopBtn.onclick = async () => {
			try {
				await invoke('stop_proxy');
				updateUI(false);

				// åœæ­¢ä»£ç†ååŒæ­¥ç³»ç»Ÿä»£ç†å¼€å…³çŠ¶æ€ï¼ˆåç«¯å·²è‡ªåŠ¨ç¦ç”¨ï¼‰
				document.getElementById('systemProxy').checked = false;
				showToast("ä»£ç†å·²åœæ­¢");
			} catch (e) { showToast(e, true); }
		};

		let lastOutputLength = 0;
		setInterval(async () => {
			if (isRunning) {
				try {
					const lines = await invoke('get_proxy_output');
					// åªæœ‰å½“æœ‰æ–°æ—¥å¿—æ—¶æ‰æ›´æ–°
					if (lines.length > lastOutputLength) {
						const newLines = lines.slice(lastOutputLength);
						newLines.forEach(line => {
							const div = document.createElement('div');
							if (line.includes('ERR')) div.className = 'stderr';
							div.textContent = line;
							dom.output.appendChild(div);
						});
						dom.output.scrollTop = dom.output.scrollHeight;
						lastOutputLength = lines.length;
					}
				} catch (e) {
					console.error('è·å–æ—¥å¿—å¤±è´¥:', e);
				}
			}
		}, 1000);
	</script>
</body>

</html>